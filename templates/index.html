<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Management Suite Pro - Web Edition</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8f9fa;
            --dark-bg: #2c3e50;
            --card-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
        }
        
        .sidebar {
            background: var(--primary-color);
            color: white;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            width: 250px;
            padding-top: 20px;
            box-shadow: 3px 0 10px rgba(0,0,0,0.1);
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
        }
        
        .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .nav-link:hover, .nav-link.active {
            background: rgba(255,255,255,0.1);
            color: white;
            text-decoration: none;
        }
        
        .nav-link i {
            width: 24px;
            text-align: center;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s;
            border: none;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .card-title {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--secondary-color);
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: var(--secondary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .btn-success {
            background: var(--success-color);
            border: none;
        }
        
        .btn-warning {
            background: var(--warning-color);
            border: none;
        }
        
        .btn-danger {
            background: var(--danger-color);
            border: none;
        }
        
        .table-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
        }
        
        .table th {
            background: var(--light-bg);
            border: none;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .badge-stock {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }
        
        .badge-low {
            background: #fee;
            color: var(--danger-color);
        }
        
        .badge-ok {
            background: #efe;
            color: var(--success-color);
        }
        
        .modal-content {
            border-radius: 12px;
            border: none;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #ddd;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar .nav-text {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .nav-link {
                text-align: center;
                padding: 15px 5px;
            }
            
            .nav-link i {
                font-size: 1.2rem;
            }
        }
        
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--card-shadow);
            height: 400px;
        }
        
        .note-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--card-shadow);
            border-left: 4px solid var(--secondary-color);
        }
        
        .note-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .note-content {
            color: #666;
            font-size: 0.9rem;
        }
        
        .note-date {
            color: #999;
            font-size: 0.8rem;
        }
        
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            padding-left: 40px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        
        .stock-alert {
            background: #fff3cd;
            border-left: 4px solid var(--warning-color);
            padding: 10px 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="text-center mb-4">
            <h4 class="mb-0"><i class="fas fa-chart-line me-2"></i><span class="nav-text">Business Suite</span></h4>
            <small class="text-muted">Web Edition</small>
        </div>
        
        <nav class="nav flex-column">
            <a class="nav-link active" href="#" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                <span class="nav-text">Dashboard</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('products')">
                <i class="fas fa-boxes"></i>
                <span class="nav-text">Products</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('transactions')">
                <i class="fas fa-exchange-alt"></i>
                <span class="nav-text">Transactions</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('customers')">
                <i class="fas fa-users"></i>
                <span class="nav-text">Customers</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('analytics')">
                <i class="fas fa-chart-bar"></i>
                <span class="nav-text">Analytics</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('notes')">
                <i class="fas fa-sticky-note"></i>
                <span class="nav-text">Notes</span>
            </a>
            <a class="nav-link" href="#" onclick="showSection('settings')">
                <i class="fas fa-cog"></i>
                <span class="nav-text">Settings</span>
            </a>
        </nav>
        
        <div class="mt-auto p-3">
            <div class="text-center">
                <button class="btn btn-sm btn-outline-light w-100 mb-2" onclick="exportData()">
                    <i class="fas fa-download"></i>
                    <span class="nav-text">Export Data</span>
                </button>
                <button class="btn btn-sm btn-outline-light w-100" onclick="backupData()">
                    <i class="fas fa-save"></i>
                    <span class="nav-text">Backup</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Dashboard</h2>
                <div class="d-flex">
                    <div class="search-box me-3">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" placeholder="Search..." style="width: 300px;">
                    </div>
                    <button class="btn btn-primary" onclick="refreshDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
            
            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="dashboard-card">
                        <div class="stat-number" id="total-sales">KES 0</div>
                        <div class="stat-label">Total Sales</div>
                        <small class="text-muted">Last 30 days</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card">
                        <div class="stat-number" id="total-products">0</div>
                        <div class="stat-label">Products</div>
                        <small class="text-muted">In stock</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card">
                        <div class="stat-number" id="total-profit">KES 0</div>
                        <div class="stat-label">Gross Profit</div>
                        <small class="text-muted">Net income</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="dashboard-card">
                        <div class="stat-number" id="stock-value">KES 0</div>
                        <div class="stat-label">Stock Value</div>
                        <small class="text-muted">Current inventory</small>
                    </div>
                </div>
            </div>
            
            <!-- Charts and Alerts -->
            <div class="row">
                <div class="col-md-8">
                    <div class="chart-container">
                        <h5>Sales Trend</h5>
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h5>Stock Alerts</h5>
                        <div id="stock-alerts">
                            <!-- Alerts will be loaded here -->
                        </div>
                    </div>
                    
                    <div class="dashboard-card mt-3">
                        <h5>Quick Actions</h5>
                        <button class="btn btn-success w-100 mb-2" onclick="showAddProductModal()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                        <button class="btn btn-primary w-100 mb-2" onclick="showAddTransactionModal()">
                            <i class="fas fa-cash-register"></i> New Sale
                        </button>
                        <button class="btn btn-warning w-100" onclick="showAddNoteModal()">
                            <i class="fas fa-sticky-note"></i> Add Note
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Recent Transactions -->
            <div class="table-container mt-4">
                <h5>Recent Transactions</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Customer/Supplier</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="recent-transactions">
                            <!-- Transactions will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Products Section -->
        <div id="products-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Product Management</h2>
                <div>
                    <button class="btn btn-primary" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="d-flex justify-content-between mb-3">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" class="form-control" id="productSearch" placeholder="Search products..." onkeyup="searchProducts()">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-outline-secondary" onclick="filterProducts('all')">All</button>
                        <button class="btn btn-outline-secondary" onclick="filterProducts('low')">Low Stock</button>
                        <button class="btn btn-outline-secondary" onclick="filterProducts('out')">Out of Stock</button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Cost</th>
                                <th>Stock</th>
                                <th>Value</th>
                                <th>Supplier</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table">
                            <!-- Products will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Transactions Section -->
        <div id="transactions-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Transaction Ledger</h2>
                <div>
                    <button class="btn btn-primary me-2" onclick="showAddTransactionModal()">
                        <i class="fas fa-plus"></i> New Transaction
                    </button>
                    <button class="btn btn-success" onclick="exportTransactions()">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Amount</th>
                                <th>Customer/Supplier</th>
                                <th>Items</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table">
                            <!-- Transactions will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Analytics Section -->
        <div id="analytics-section" style="display: none;">
            <h2 class="mb-4">Analytics Dashboard</h2>
            
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="chart-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Sales Analytics</h5>
                            <select class="form-select w-auto" id="periodSelect" onchange="updateAnalytics()">
                                <option value="7">Last 7 Days</option>
                                <option value="30" selected>Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                            </select>
                        </div>
                        <canvas id="analyticsChart"></canvas>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="dashboard-card">
                        <h5>Top Products</h5>
                        <div id="top-products">
                            <!-- Top products will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="chart-container">
                        <h5>Inventory Value by Category</h5>
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="dashboard-card">
                        <h5>Performance Metrics</h5>
                        <div id="performance-metrics">
                            <!-- Metrics will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notes Section -->
        <div id="notes-section" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="mb-0">Notes & Documentation</h2>
                <button class="btn btn-primary" onclick="showAddNoteModal()">
                    <i class="fas fa-plus"></i> Add Note
                </button>
            </div>
            
            <div class="row" id="notes-container">
                <!-- Notes will be loaded here -->
            </div>
        </div>
        
        <!-- Settings Section -->
        <div id="settings-section" style="display: none;">
            <h2 class="mb-4">Settings</h2>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="dashboard-card">
                        <h5>Data Management</h5>
                        <div class="mb-3">
                            <button class="btn btn-success w-100 mb-2" onclick="exportProducts()">
                                <i class="fas fa-file-csv"></i> Export Products to CSV
                            </button>
                            <button class="btn btn-primary w-100 mb-2" onclick="exportTransactions()">
                                <i class="fas fa-file-csv"></i> Export Transactions to CSV
                            </button>
                            <button class="btn btn-warning w-100" onclick="backupData()">
                                <i class="fas fa-save"></i> Backup All Data
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="dashboard-card">
                        <h5>Restore Data</h5>
                        <div class="mb-3">
                            <input type="file" class="form-control mb-3" id="restoreFile" accept=".json">
                            <button class="btn btn-danger w-100" onclick="restoreData()">
                                <i class="fas fa-upload"></i> Restore from Backup
                            </button>
                            <small class="text-muted">Warning: This will replace all current data</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <div class="mb-3">
                            <label>Product Name</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>Price (KES)</label>
                                <input type="number" class="form-control" id="productPrice" required>
                            </div>
                            <div class="col-md-6">
                                <label>Cost (KES)</label>
                                <input type="number" class="form-control" id="productCost" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>Stock</label>
                                <input type="number" class="form-control" id="productStock" required>
                            </div>
                            <div class="col-md-6">
                                <label>Category</label>
                                <input type="text" class="form-control" id="productCategory">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>Supplier</label>
                            <input type="text" class="form-control" id="productSupplier">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Transaction Modal -->
    <div class="modal fade" id="addTransactionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="transactionForm">
                        <div class="mb-3">
                            <label>Transaction Type</label>
                            <select class="form-select" id="transactionType" onchange="toggleTransactionFields()">
                                <option value="sale">Sale</option>
                                <option value="purchase">Purchase</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label id="customerLabel">Customer</label>
                            <input type="text" class="form-control" id="transactionCustomer">
                        </div>
                        <div class="mb-3">
                            <label>Amount (KES)</label>
                            <input type="number" class="form-control" id="transactionAmount" required>
                        </div>
                        <div class="mb-3">
                            <label>Description</label>
                            <textarea class="form-control" id="transactionDescription" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTransaction()">Save Transaction</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Note Modal -->
    <div class="modal fade" id="addNoteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="noteForm">
                        <div class="mb-3">
                            <label>Title</label>
                            <input type="text" class="form-control" id="noteTitle" required>
                        </div>
                        <div class="mb-3">
                            <label>Content</label>
                            <textarea class="form-control" id="noteContent" rows="5" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label>Category</label>
                            <input type="text" class="form-control" id="noteCategory">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNote()">Save Note</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main Application JavaScript -->
    <script>
        // Global variables
        let currentSection = 'dashboard';
        let products = [];
        let transactions = [];
        let notes = [];
        let salesChart = null;
        let analyticsChart = null;
        let categoryChart = null;
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            loadProducts();
            loadTransactions();
            loadNotes();
            
            // Initialize tooltips
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
        
        // Navigation
        function showSection(section) {
            // Hide all sections
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('products-section').style.display = 'none';
            document.getElementById('transactions-section').style.display = 'none';
            document.getElementById('analytics-section').style.display = 'none';
            document.getElementById('notes-section').style.display = 'none';
            document.getElementById('settings-section').style.display = 'none';
            
            // Update nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show selected section
            document.getElementById(`${section}-section`).style.display = 'block';
            currentSection = section;
            
            // Load section data
            if (section === 'dashboard') {
                loadDashboard();
            } else if (section === 'products') {
                loadProducts();
            } else if (section === 'transactions') {
                loadTransactions();
            } else if (section === 'analytics') {
                loadAnalytics();
            } else if (section === 'notes') {
                loadNotes();
            }
        }
        
        // Load Dashboard Data
        async function loadDashboard() {
            try {
                // Load balance data
                const balanceResponse = await fetch('/api/analytics/balance');
                const balanceData = await balanceResponse.json();
                
                // Update stats
                document.getElementById('total-sales').textContent = `KES ${balanceData.income.toLocaleString()}`;
                document.getElementById('total-products').textContent = balanceData.total_products;
                document.getElementById('total-profit').textContent = `KES ${balanceData.gross_profit.toLocaleString()}`;
                document.getElementById('stock-value').textContent = `KES ${balanceData.stock_value.toLocaleString()}`;
                
                // Load sales chart
                const salesResponse = await fetch('/api/analytics/sales?days=30');
                const salesData = await salesResponse.json();
                
                // Create sales chart
                if (salesChart) salesChart.destroy();
                const ctx = document.getElementById('salesChart').getContext('2d');
                salesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: salesData.dates.map(date => date.split('-')[2]),
                        datasets: [{
                            label: 'Daily Sales (KES)',
                            data: salesData.sales,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'KES ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Load stock alerts
                loadStockAlerts();
                
                // Load recent transactions
                loadRecentTransactions();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showAlert('Error loading dashboard data', 'danger');
            }
        }
        
        // Load Products
        async function loadProducts() {
            try {
                const response = await fetch('/api/products');
                products = await response.json();
                displayProducts(products);
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }
        
        function displayProducts(productList) {
            const table = document.getElementById('products-table');
            table.innerHTML = '';
            
            productList.forEach(product => {
                const stockStatus = product.stock <= product.min_stock ? 'badge-low' : 'badge-ok';
                const stockText = product.stock <= product.min_stock ? 'Low' : 'OK';
                const stockValue = product.price * product.stock;
                
                const row = `
                    <tr>
                        <td>${product.name}</td>
                        <td>${product.category || '-'}</td>
                        <td>KES ${product.price.toLocaleString()}</td>
                        <td>KES ${product.cost?.toLocaleString() || '-'}</td>
                        <td>
                            <span class="badge-stock ${stockStatus}">${product.stock} (${stockText})</span>
                        </td>
                        <td>KES ${stockValue.toLocaleString()}</td>
                        <td>${product.supplier || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editProduct(${product.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                table.innerHTML += row;
            });
        }
        
        // Product Search and Filter
        function searchProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const filtered = products.filter(product => 
                product.name.toLowerCase().includes(searchTerm) ||
                (product.category && product.category.toLowerCase().includes(searchTerm)) ||
                (product.supplier && product.supplier.toLowerCase().includes(searchTerm))
            );
            displayProducts(filtered);
        }
        
        function filterProducts(type) {
            let filtered = products;
            if (type === 'low') {
                filtered = products.filter(p => p.stock <= (p.min_stock || 5));
            } else if (type === 'out') {
                filtered = products.filter(p => p.stock <= 0);
            }
            displayProducts(filtered);
        }
        
        // Product CRUD Operations
        function showAddProductModal() {
            document.getElementById('productForm').reset();
            new bootstrap.Modal(document.getElementById('addProductModal')).show();
        }
        
        async function saveProduct() {
            const product = {
                name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                cost: parseFloat(document.getElementById('productCost').value),
                stock: parseInt(document.getElementById('productStock').value),
                category: document.getElementById('productCategory').value,
                supplier: document.getElementById('productSupplier').value,
                min_stock: 5,
                max_stock: 100
            };
            
            try {
                const response = await fetch('/api/products', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(product)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                    loadProducts();
                    loadDashboard();
                    showAlert('Product added successfully!', 'success');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showAlert('Error saving product', 'danger');
            }
        }
        
        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                document.getElementById('productName').value = product.name;
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productCost').value = product.cost || '';
                document.getElementById('productStock').value = product.stock;
                document.getElementById('productCategory').value = product.category || '';
                document.getElementById('productSupplier').value = product.supplier || '';
                new bootstrap.Modal(document.getElementById('addProductModal')).show();
                
                // TODO: Update save function to handle edits
            }
        }
        
        async function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                try {
                    const response = await fetch(`/api/products/${productId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        loadProducts();
                        loadDashboard();
                        showAlert('Product deleted successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Error deleting product:', error);
                    showAlert('Error deleting product', 'danger');
                }
            }
        }
        
        // Transactions
        async function loadTransactions() {
            try {
                const response = await fetch('/api/transactions');
                transactions = await response.json();
                displayTransactions(transactions);
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }
        
        function displayTransactions(transactionList) {
            const table = document.getElementById('transactions-table');
            table.innerHTML = '';
            
            transactionList.forEach(transaction => {
                const typeBadge = transaction.type === 'sale' ? 
                    '<span class="badge bg-success">Sale</span>' : 
                    '<span class="badge bg-warning">Purchase</span>';
                
                const row = `
                    <tr>
                        <td>${transaction.date}</td>
                        <td>${typeBadge}</td>
                        <td>KES ${transaction.amount.toLocaleString()}</td>
                        <td>${transaction.customer || transaction.supplier || '-'}</td>
                        <td>${transaction.items ? transaction.items.length + ' items' : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-info">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
                table.innerHTML += row;
            });
        }
        
        function loadRecentTransactions() {
            const recent = transactions.slice(-5).reverse();
            const table = document.getElementById('recent-transactions');
            table.innerHTML = '';
            
            recent.forEach(transaction => {
                const typeBadge = transaction.type === 'sale' ? 
                    '<span class="badge bg-success">Sale</span>' : 
                    '<span class="badge bg-warning">Purchase</span>';
                
                const row = `
                    <tr>
                        <td>${transaction.date.split(' ')[0]}</td>
                        <td>${typeBadge}</td>
                        <td>KES ${transaction.amount.toLocaleString()}</td>
                        <td>${transaction.customer || transaction.supplier || '-'}</td>
                        <td>${transaction.description || '-'}</td>
                    </tr>
                `;
                table.innerHTML += row;
            });
        }
        
        function showAddTransactionModal() {
            document.getElementById('transactionForm').reset();
            toggleTransactionFields();
            new bootstrap.Modal(document.getElementById('addTransactionModal')).show();
        }
        
        function toggleTransactionFields() {
            const type = document.getElementById('transactionType').value;
            const label = document.getElementById('customerLabel');
            if (type === 'sale') {
                label.textContent = 'Customer';
                document.getElementById('transactionCustomer').placeholder = 'Enter customer name';
            } else {
                label.textContent = 'Supplier';
                document.getElementById('transactionCustomer').placeholder = 'Enter supplier name';
            }
        }
        
        async function saveTransaction() {
            const type = document.getElementById('transactionType').value;
            const transaction = {
                type: type,
                amount: parseFloat(document.getElementById('transactionAmount').value),
                description: document.getElementById('transactionDescription').value
            };
            
            if (type === 'sale') {
                transaction.customer = document.getElementById('transactionCustomer').value;
            } else {
                transaction.supplier = document.getElementById('transactionCustomer').value;
            }
            
            try {
                const response = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(transaction)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addTransactionModal')).hide();
                    loadTransactions();
                    loadDashboard();
                    showAlert('Transaction added successfully!', 'success');
                }
            } catch (error) {
                console.error('Error saving transaction:', error);
                showAlert('Error saving transaction', 'danger');
            }
        }
        
        // Notes
        async function loadNotes() {
            try {
                const response = await fetch('/api/notes');
                notes = await response.json();
                displayNotes(notes);
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }
        
        function displayNotes(noteList) {
            const container = document.getElementById('notes-container');
            container.innerHTML = '';
            
            noteList.forEach(note => {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-3';
                col.innerHTML = `
                    <div class="note-card">
                        <div class="note-title">${note.title}</div>
                        <div class="note-content">${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}</div>
                        <div class="note-date mt-2">
                            ${new Date(note.created_at).toLocaleDateString()}
                            <button class="btn btn-sm btn-outline-danger float-end" onclick="deleteNote('${note.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }
        
        function showAddNoteModal() {
            document.getElementById('noteForm').reset();
            new bootstrap.Modal(document.getElementById('addNoteModal')).show();
        }
        
        async function saveNote() {
            const note = {
                title: document.getElementById('noteTitle').value,
                content: document.getElementById('noteContent').value,
                category: document.getElementById('noteCategory').value
            };
            
            try {
                const response = await fetch('/api/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(note)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('addNoteModal')).hide();
                    loadNotes();
                    showAlert('Note added successfully!', 'success');
                }
            } catch (error) {
                console.error('Error saving note:', error);
                showAlert('Error saving note', 'danger');
            }
        }
        
        async function deleteNote(noteId) {
            if (confirm('Are you sure you want to delete this note?')) {
                try {
                    const response = await fetch(`/api/notes/${noteId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        loadNotes();
                        showAlert('Note deleted successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Error deleting note:', error);
                    showAlert('Error deleting note', 'danger');
                }
            }
        }
        
        // Analytics
        async function loadAnalytics() {
            try {
                const days = document.getElementById('periodSelect').value;
                const response = await fetch(`/api/analytics/sales?days=${days}`);
                const data = await response.json();
                
                // Update analytics chart
                if (analyticsChart) analyticsChart.destroy();
                const ctx = document.getElementById('analyticsChart').getContext('2d');
                analyticsChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.dates.map(date => date.split('-')[2]),
                        datasets: [{
                            label: 'Daily Sales (KES)',
                            data: data.sales,
                            backgroundColor: 'rgba(52, 152, 219, 0.5)',
                            borderColor: '#3498db',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'KES ' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Update top products
                const topProductsDiv = document.getElementById('top-products');
                topProductsDiv.innerHTML = '';
                data.top_products.forEach((product, index) => {
                    const div = document.createElement('div');
                    div.className = 'd-flex justify-content-between mb-2';
                    div.innerHTML = `
                        <span>${index + 1}. ${product[0]}</span>
                        <span class="text-primary">KES ${product[1].toLocaleString()}</span>
                    `;
                    topProductsDiv.appendChild(div);
                });
                
                // Update performance metrics
                const metricsDiv = document.getElementById('performance-metrics');
                metricsDiv.innerHTML = `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>Total Sales:</span>
                            <span class="fw-bold">KES ${data.total_sales.toLocaleString()}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Avg Daily Sales:</span>
                            <span class="fw-bold">KES ${data.avg_daily_sales.toLocaleString()}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Days Analyzed:</span>
                            <span class="fw-bold">${days} days</span>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }
        
        function updateAnalytics() {
            loadAnalytics();
        }
        
        // Stock Alerts
        async function loadStockAlerts() {
            const alertsDiv = document.getElementById('stock-alerts');
            alertsDiv.innerHTML = '';
            
            products.forEach(product => {
                if (product.stock <= (product.min_stock || 5)) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'stock-alert';
                    alertDiv.innerHTML = `
                        <strong>${product.name}</strong><br>
                        <small>Stock: ${product.stock} (Low)</small>
                    `;
                    alertsDiv.appendChild(alertDiv);
                }
            });
            
            if (alertsDiv.children.length === 0) {
                alertsDiv.innerHTML = '<div class="text-center text-muted">No stock alerts</div>';
            }
        }
        
        // Export Functions
        function exportProducts() {
            window.open('/api/export/csv/products', '_blank');
        }
        
        function exportTransactions() {
            window.open('/api/export/csv/transactions', '_blank');
        }
        
        async function backupData() {
            try {
                const response = await fetch('/api/backup');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `business_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                showAlert('Backup created successfully!', 'success');
            } catch (error) {
                console.error('Error creating backup:', error);
                showAlert('Error creating backup', 'danger');
            }
        }
        
        async function restoreData() {
            const fileInput = document.getElementById('restoreFile');
            if (!fileInput.files.length) {
                showAlert('Please select a backup file', 'warning');
                return;
            }
            
            if (!confirm('Warning: This will replace all current data. Continue?')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            
            try {
                const response = await fetch('/api/restore', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    showAlert('Data restored successfully!', 'success');
                    // Reload all data
                    loadDashboard();
                    loadProducts();
                    loadTransactions();
                    loadNotes();
                    fileInput.value = '';
                } else {
                    showAlert('Error restoring data', 'danger');
                }
            } catch (error) {
                console.error('Error restoring data:', error);
                showAlert('Error restoring data', 'danger');
            }
        }
        
        function exportData() {
            backupData();
        }
        
        // Utility Functions
        function refreshDashboard() {
            loadDashboard();
            showAlert('Dashboard refreshed!', 'info');
        }
        
        function showAlert(message, type) {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '9999';
            alertDiv.style.minWidth = '300px';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
